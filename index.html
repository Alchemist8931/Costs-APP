<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <!-- PWA & iOS fullscreen -->
  <link rel="manifest" href="/manifest.json">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Costs App">
  <meta name="mobile-web-app-capable" content="yes">
  <link rel="apple-touch-icon" href="/icons/icon-192.png">
  <title>Финансовый журнал: Расходы/Доходы</title>
  <style>
    /* ===== :root — палитра и размеры (можно легко менять под пользователей) ===== */
    :root{
      --bg-image-url: url("https://drive.google.com/uc?export=view&id=1VBisGzu10gglUjR8WP92DseOPlYGFfNH"); /* фон с Google Drive */
      --text: #ffffff;
      --muted: #cfd3dc;
      --accent: #5ad1ff;
      --accent-2: #9ae6b4;
      --danger: #ff6b6b;
      --card: rgba(8, 10, 14, 0.72);
      --card-strong: rgba(8, 10, 14, 0.92);
      --border: rgba(255,255,255,0.15);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --radius: 16px;
      --radius-sm: 12px;

      --input-h: 46px;
      --container-w: min(1100px, 92vw);
      --list-h: min(52vh, 520px);
    }

    /* ===== Базовый фон ===== */
    html, body { height:100%; overflow-y: hidden; }
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial;
      color: var(--text);
      background: #0b0f14;
      background-image: var(--bg-image-url);
      background-size: cover;
      background-position: center;
      background-attachment: fixed;
    }
    body::before{
      content:"";
      position:fixed; inset:0;
      background: radial-gradient(1200px 700px at 20% 15%, rgba(0,0,0,0.25), transparent 65%),
                  linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.75));
      pointer-events:none;
    }

    /* ===== Экран PIN-замка ===== */
    #lock-screen{
      position: fixed; inset:0; display: grid; place-items:center;
      backdrop-filter: blur(6px); background: rgba(0,0,0,0.45); z-index: 9999;
    }
    .lock-card{
      width: min(460px, 90vw); padding: 28px; background: var(--card-strong);
      border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
    }
    .lock-title{ font-size: 20px; margin: 0 0 10px 0; font-weight: 700; }
    .lock-sub{ color: var(--muted); margin: 0 0 18px 0; font-size: 14px; }
    .pin-row{ display:flex; gap: 10px; align-items:center; }
    .pin-input{
      flex:1; height: var(--input-h); border-radius: 12px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06); color: var(--text); padding: 0 14px; font-size: 16px; outline: none;
    }
    .btn{
      height: var(--input-h); padding: 0 16px; border: 1px solid var(--border);
      border-radius: 12px; background: linear-gradient(180deg, rgba(90,209,255,0.25), rgba(90,209,255,0.1));
      color: var(--text); font-weight: 600; cursor: pointer;
    }
    .pin-hint{ margin-top: 10px; color: var(--muted); font-size: 12px; }

    /* ===== Каркас приложения ===== */
    .app-wrap{ display:flex; align-items:center; justify-content:center; min-height: 100dvh; }
    .app-card{
      width: var(--container-w); background: var(--card); border: 1px solid var(--border);
      border-radius: var(--radius); box-shadow: var(--shadow); overflow: hidden; position: relative;
    }
    .app-header{
      display:flex; justify-content:space-between; align-items:center;
      padding: 16px 18px; background: rgba(255,255,255,0.04); border-bottom: 1px solid var(--border);
    }
    .brand{ display:flex; gap: 10px; align-items:center; font-weight: 800; letter-spacing: .5px; }
    .brand .tag{
      color: var(--muted); font-weight: 600; font-size: 12px; padding: 2px 8px;
      border: 1px solid var(--border); border-radius: 999px; background: rgba(255,255,255,0.04);
    }
    .user-pill{
      color: var(--muted); font-size: 13px; border: 1px solid var(--border);
      border-radius: 999px; padding: 6px 12px; background: rgba(255,255,255,0.03);
    }

    /* ===== Табы и свайп ===== */
    .tabs{ display:flex; gap:8px; padding: 12px 12px 2px 12px; border-bottom: 1px solid var(--border); background: rgba(255,255,255,0.02); }
    .tab{ padding: 10px 14px; border: 1px solid var(--border); border-bottom: none; border-radius: 12px 12px 0 0; background: rgba(255,255,255,0.03); color: var(--muted); font-weight: 600; cursor: pointer; }
    .tab.active{ color: var(--text); background: rgba(255,255,255,0.08); }
    .swipe-hint{ text-align:center; font-size: 12px; color: var(--muted); padding: 6px 0 10px 0; }

    .pages{ position: relative; width: 200%; display: flex; transition: transform .35s ease; }
    .page{ width: 50%; padding: 14px; box-sizing: border-box; }

    .actions{ display:flex; gap: 10px; align-items:center; justify-content: space-between; margin-bottom: 10px; }
    .list-card{
      height: var(--list-h); overflow-y: auto; overscroll-behavior: contain;
      border: 1px solid var(--border); border-radius: var(--radius-sm); background: rgba(20, 24, 30, 0.55);
    }

    /* ===== Строки ===== */
    .row{
      display:grid; grid-template-columns: 64px 160px 1fr 1fr 160px 180px;
      gap: 10px; padding: 10px 12px; align-items:center; border-bottom: 1px dashed var(--border);
    }
    .row.head{
      position: sticky; top: 0; background: rgba(8,10,14,0.9); border-bottom: 1px solid var(--border);
      z-index: 1; font-size: 12px; color: var(--muted); text-transform: uppercase; letter-spacing: .6px;
    }
    .field{
      height: var(--input-h); border-radius: 10px; border: 1px solid var(--border);
      background: rgba(255,255,255,0.06); color: var(--text); padding: 0 12px; font-size: 14px; outline: none;
    }
    .field[readonly]{ opacity:.85 }
    .field.short{ text-align: center; }

    /* ===== Модал создания ===== */
    .modal{ position: fixed; inset:0; display:none; align-items:center; justify-content:center; background: rgba(0,0,0,0.55); z-index: 9000; }
    .modal.open{ display:flex; }
    .modal-card{
        width: min(560px, 92vw); padding: 18px; background: var(--card-strong);
        border: 1px solid var(--border); border-radius: var(--radius); box-shadow: var(--shadow);
        max-height: 90vh; overflow-y: auto;
      }
    .modal-title{ margin: 0 0 12px 0; font-size: 18px; font-weight: 800; }
    .grid{ display:grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .form-actions{ display:flex; gap:10px; justify-content: flex-end; margin-top: 14px; }
    .hint{ font-size: 12px; color: var(--muted); margin-top: 6px; }

    @media (max-width: 980px){
      .row{ grid-template-columns: 52px 132px 1fr 1fr 132px 150px; }
    }
    @media (max-width: 760px){
      .row{ grid-template-columns: 44px 116px 1fr 1fr; grid-auto-rows: var(--input-h); }
      .col-date{ grid-column: 1 / span 2; }
      .col-amount{ grid-column: 3 / span 2; }
    }
  </style>
</head>
<body>

  <!-- ===== Экран PIN ===== -->
  <div id="lock-screen">
    <div class="lock-card">
      <h3 class="lock-title">Доступ по PIN-коду</h3>
      <p class="lock-sub">Введите PIN. Контент приложения скрыт до успешной авторизации.</p>
      <div class="pin-row">
        <input id="pin" class="pin-input" type="password" maxlength="8" placeholder="Введите PIN…" />
        <button id="pinSubmit" class="btn">Войти</button>
      </div>
      <div class="pin-hint">PIN 8931 → <b>Alchemist</b> · PIN 2401 → <b>Ardente Stella</b></div>
      <div id="pinError" class="pin-hint" style="color:var(--danger); display:none;">Неверный PIN</div>
    </div>
  </div>

  <!-- ===== Приложение ===== -->
  <div class="app-wrap" aria-hidden="true" id="appRoot" style="filter: blur(4px); pointer-events:none;">
    <div class="app-card" id="swipeArea">
      <div class="app-header">
        <div class="brand">Финансовый журнал <span class="tag">без OAuth на клиенте</span></div>
        <div class="user-pill" id="userPill">Пользователь: —</div>
      </div>

      <div class="tabs">
        <div class="tab active" id="tab-exp">Расходы</div>
        <div class="tab" id="tab-inc">Доходы</div>
        <div style="flex:1"></div>
        <div style="color:var(--muted); font-size:13px;">Статус данных: <b id="statusText">…</b></div>
      </div>
      <div class="swipe-hint">Смахивайте влево/вправо для переключения между страницами</div>

      <div class="pages" id="pages">
        <!-- Расходы -->
        <section class="page" id="page-exp">
          <div class="actions">
            <button class="btn" id="createExpBtn">Создать расход</button>
            <div style="color:var(--muted); font-size:13px;">Текущая вкладка: <b>Расходы</b></div>
          </div>
          <div class="list-card" id="expList">
            <div class="row head">
              <div>№ п/п</div><div>Пользователь</div><div>Источник</div><div>Категория</div><div>Дата</div><div>Сумма</div>
            </div>
          </div>
        </section>
        <!-- Доходы -->
        <section class="page" id="page-inc">
          <div class="actions">
            <button class="btn" id="createIncBtn">Создать доход</button>
            <div style="color:var(--muted); font-size:13px;">Текущая вкладка: <b>Доходы</b></div>
          </div>
          <div class="list-card" id="incList">
            <div class="row head">
              <div>№ п/п</div><div>Пользователь</div><div>Источник</div><div>Категория</div><div>Дата</div><div>Сумма</div>
            </div>
          </div>
        </section>
      </div>
    </div>
  </div>

  <!-- ===== Модал создания ===== -->
  <div class="modal" id="modalCreate">
    <div class="modal-card">
      <h4 class="modal-title" id="modalTitle">Создание операции</h4>
      <div class="grid">
        <div>
          <label>Источник</label>
          <input id="inpSource" class="field" list="dlSource" placeholder="Введите или выберите…"/>
          <datalist id="dlSource"></datalist>
        </div>
        <div>
          <label>Категория</label>
          <input id="inpCategory" class="field" list="dlCategory" placeholder="Введите или выберите…"/>
          <datalist id="dlCategory"></datalist>
        </div>
        <div>
          <label>Дата</label>
          <input id="inpDate" class="field" type="date"/>
        </div>
        <div>
          <label>Сумма</label>
          <input id="inpAmount" class="field" inputmode="numeric" placeholder="Только целое число"/>
        </div>
      </div>
      <div class="hint">№ и Пользователь проставятся автоматически</div>
      <div class="form-actions">
        <button class="btn" id="btnSave">Сохранить</button>
        <button class="btn" style="background:rgba(255,255,255,0.08)" id="btnCancel">Отмена</button>
      </div>
      <div id="formErr" class="hint" style="color:var(--danger); display:none;">Заполните корректно все поля</div>
    </div>
  </div>

  <script>
    // ================== НАСТРОЙКИ БЕКЕНДА (Apps Script) ==================
    // //БАЗОВЫЕ ПАРАМЕТРЫ ДЛЯ ЗАПРОСОВ К GAS
    const GAS_URL   = "https://script.google.com/macros/s/AKfycbzTquTIOYREKr0mw1P7YgAB0MarXp1vdZwQj84nAG24yaa6nwNnzQQhrOr_pYEZDa3W/exec";           // //вставьте URL развёрнутого Web App
    const GAS_TOKEN = "123iuehdkeqjdu28-23nm2bj3h2jh32kh3db";         // //точно такой же, как SCRIPT_TOKEN в Code.gs

    // ================== ПЕРЕМЕННЫЕ ПРИЛОЖЕНИЯ ==================
    // //пользователи по PIN
    const PIN_MAP = { "8931": "Alchemist", "2401": "Ardente Stella" };
    // //локальные кэши
    let currentUser = null;
    let currentPage = "exp"; // exp|inc
    let cacheExp = [];
    let cacheInc = [];
    let uniqueSourcesExp = new Set();
    let uniqueCatsExp    = new Set();
    let uniqueSourcesInc = new Set();
    let uniqueCatsInc    = new Set();
    let createMode = "exp"; // текущий лист для модалки

    // ================== УТИЛИТЫ ==================
    // //функция форматирования суммы "1 234 567"
    function fmtAmount(num){
      try{
        const n = Number(num);
        if (Number.isNaN(n)) return "";
        return n.toLocaleString('ru-RU', {maximumFractionDigits:0});
      }catch(e){ return ""; }
    }
    // //функция: строка → целое число
    function parseAmountInput(s){
      if(!s) return NaN;
      const digits = (s+"").replace(/[^\d]/g,"");
      return digits ? Number(digits) : NaN;
    }
    // //функция: сегодняшняя дата yyyy-mm-dd
    function todayISO(){
      const d = new Date();
      const mm = String(d.getMonth()+1).padStart(2,"0");
      const dd = String(d.getDate()).padStart(2,"0");
      return `${d.getFullYear()}-${mm}-${dd}`;
    }
    // //функция: прокрутка к началу
    function scrollTop(el){ try{ el.scrollTo({top:0, behavior:"smooth"}); }catch{} }

    // ================== API КЛИЕНТ ДЛЯ GAS ==================
    // //функция: список строк (mode=list)
    async function apiList(kind){
      const sheet = (kind === 'exp') ? 'Expenses' : 'Incomes';
      const url = `${GAS_URL}?mode=list&sheet=${encodeURIComponent(sheet)}&token=${encodeURIComponent(GAS_TOKEN)}`;
      const res = await fetch(url, { method: 'GET' }); // //простая GET, без preflight
      if(!res.ok) throw new Error('fetch list failed');
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'api error');
      return data.rows || [];
    }
    // //функция: добавить строку (mode=append), x-www-form-urlencoded (без preflight)
    async function apiAppend(kind, rowObj){
      const sheet = (kind === 'exp') ? 'Expenses' : 'Incomes';
      const body = new URLSearchParams();
      body.set('mode', 'append');
      body.set('sheet', sheet);
      body.set('token', GAS_TOKEN);
      body.set('rowJson', JSON.stringify(rowObj));
      const res = await fetch(GAS_URL, {
        method: 'POST',
        headers: { 'Content-Type': 'application/x-www-form-urlencoded;charset=UTF-8' },
        body: body.toString()
      });
      if(!res.ok) throw new Error('append failed');
      const data = await res.json();
      if(!data.ok) throw new Error(data.error || 'api err');
      return data.row;
    }

    // ================== ЗАГРУЗКА ДАННЫХ И РЕНДЕР ==================
    // //функция: загрузить обе таблицы
    async function loadAllData(){
      setStatus('Загрузка…');
      try{
        const [exp, inc] = await Promise.all([apiList('exp'), apiList('inc')]);
        cacheExp = exp; cacheInc = inc;

        uniqueSourcesExp = new Set(exp.map(r => r[2]).filter(Boolean));
        uniqueCatsExp    = new Set(exp.map(r => r[3]).filter(Boolean));
        uniqueSourcesInc = new Set(inc.map(r => r[2]).filter(Boolean));
        uniqueCatsInc    = new Set(inc.map(r => r[3]).filter(Boolean));

        renderList('exp', exp);
        renderList('inc', inc);
        rebuildDatalists();
        setStatus('Готово');
      }catch(e){
        console.error(e);
        setStatus('Ошибка');
      }
    }

    // //функция: рендер списка
    function renderList(kind, rows){
      const listEl = (kind === "exp") ? document.getElementById('expList') : document.getElementById('incList');
      listEl.querySelectorAll('.row.item').forEach(n => n.remove());
      rows.forEach((r, idx)=>{
        const [no, user, source, category, date, amount] = [
          r[0] || (idx+1),
          r[1] || "",
          r[2] || "",
          r[3] || "",
          r[4] || "",
          r[5] || ""
        ];
        const row = document.createElement('div');
        row.className = 'row item';
        row.innerHTML = `
          <input class="field short" value="${no}" readonly title="№ п/п"/>
          <input class="field" value="${user}" readonly title="Пользователь"/>
          <input class="field" value="${source}" readonly title="Источник"/>
          <input class="field" value="${category}" readonly title="Категория"/>
          <input class="field col-date" value="${date}" readonly title="Дата"/>
          <input class="field col-amount" value="${fmtAmount(amount)}" readonly title="Сумма"/>
        `;
        listEl.appendChild(row);
      });
    }

    // //функция: обновить datalist в модалке
    function rebuildDatalists(){
      const dlSource = document.getElementById('dlSource');
      const dlCategory = document.getElementById('dlCategory');
      dlSource.innerHTML = ''; dlCategory.innerHTML = '';
      const srcSet = (createMode === "exp") ? uniqueSourcesExp : uniqueSourcesInc;
      const catSet = (createMode === "exp") ? uniqueCatsExp    : uniqueCatsInc;
      srcSet.forEach(v=>{ const opt = document.createElement('option'); opt.value = v; dlSource.appendChild(opt); });
      catSet.forEach(v=>{ const opt = document.createElement('option'); opt.value = v; dlCategory.appendChild(opt); });
    }

    // //функция: статус текста
    function setStatus(txt){ document.getElementById('statusText').textContent = txt; }

    // ================== МОДАЛ СОЗДАНИЯ ==================
    // //функция: открыть модал
    function openCreate(kind){
      createMode = kind;
      document.getElementById('modalTitle').textContent = (kind === "exp") ? "Создание расходной операции" : "Создание доходной операции";
      document.getElementById('formErr').style.display = 'none';
      document.getElementById('inpDate').value = todayISO();
      document.getElementById('inpSource').value = "";
      document.getElementById('inpCategory').value = "";
      document.getElementById('inpAmount').value = "";
      rebuildDatalists();
      document.getElementById('modalCreate').classList.add('open');
    }
    // //функция: закрыть модал
    function closeCreate(){ document.getElementById('modalCreate').classList.remove('open'); }

    // //функция: сохранить запись (через GAS)
    async function saveRecord(){
      const src = document.getElementById('inpSource').value.trim();
      const cat = document.getElementById('inpCategory').value.trim();
      const date = document.getElementById('inpDate').value.trim();
      const amountStr = document.getElementById('inpAmount').value.trim();
      const err = document.getElementById('formErr');

      const amount = parseAmountInput(amountStr);
      if(!src || !cat || !date || !Number.isFinite(amount)){
        err.style.display = 'block';
        return;
      }
      if(!currentUser){ alert("Нет пользователя. Сначала разблокируйте по PIN."); return; }

      try{
        const row = await apiAppend(createMode, {
          user: currentUser, source: src, category: cat, date, amount
        });
        // //обновить локальный кэш и UI
        if (createMode === 'exp') {
          cacheExp.push(row);
          uniqueSourcesExp.add(src); uniqueCatsExp.add(cat);
          renderList('exp', cacheExp);
          scrollTop(document.getElementById('expList'));
        } else {
          cacheInc.push(row);
          uniqueSourcesInc.add(src); uniqueCatsInc.add(cat);
          renderList('inc', cacheInc);
          scrollTop(document.getElementById('incList'));
        }
        closeCreate();
      }catch(e){
        console.error(e);
        alert("Ошибка записи. Проверьте Web App URL/токен и доступ к таблице.");
      }
    }

    // ================== СВАЙП МЕЖДУ СТРАНИЦАМИ ==================
    // //функция: установить страницу
    function setPage(kind){
      currentPage = kind;
      const pages = document.getElementById('pages');
      const tabExp = document.getElementById('tab-exp');
      const tabInc = document.getElementById('tab-inc');
      if (kind === "exp"){
        pages.style.transform = 'translateX(0%)';
        tabExp.classList.add('active'); tabInc.classList.remove('active');
      } else {
        pages.style.transform = 'translateX(-50%)';
        tabInc.classList.add('active'); tabExp.classList.remove('active');
      }
    }
    // //обработчики свайпа
    let dragStartX = null, dragging = false;
    function onPointerDown(e){ dragging = true; dragStartX = e.touches ? e.touches[0].clientX : e.clientX; }
    function onPointerUp(e){
      if(!dragging) return; dragging = false;
      const endX = e.changedTouches ? e.changedTouches[0].clientX : e.clientX;
      const delta = endX - dragStartX;
      if (Math.abs(delta) > 60){
        if (delta < 0 && currentPage === "exp") setPage("inc");
        else if (delta > 0 && currentPage === "inc") setPage("exp");
      }
    }

    // ================== ПРИВЯЗКА СОБЫТИЙ ==================
    window.addEventListener('DOMContentLoaded', ()=>{
      // //PIN
      document.getElementById('pinSubmit').addEventListener('click', unlockByPin);
      document.getElementById('pin').addEventListener('keydown', (e)=> { if(e.key === 'Enter') unlockByPin(); });

      // //табы
      document.getElementById('tab-exp').addEventListener('click', ()=> setPage('exp'));
      document.getElementById('tab-inc').addEventListener('click', ()=> setPage('inc'));

      // //создание записей
      document.getElementById('createExpBtn').addEventListener('click', ()=> openCreate('exp'));
      document.getElementById('createIncBtn').addEventListener('click', ()=> openCreate('inc'));
      document.getElementById('btnCancel').addEventListener('click', closeCreate);
      document.getElementById('btnSave').addEventListener('click', saveRecord);

      // //формат суммы «на лету»
      document.getElementById('inpAmount').addEventListener('input', (e)=>{
        const num = parseAmountInput(e.target.value);
        e.target.value = Number.isFinite(num) ? fmtAmount(num) : "";
        try{ e.target.setSelectionRange(e.target.value.length, e.target.value.length); }catch{}
      });

      // //свайп
      const swipeArea = document.getElementById('swipeArea');
      swipeArea.addEventListener('touchstart', onPointerDown, {passive:true});
      swipeArea.addEventListener('touchend', onPointerUp, {passive:true});
      swipeArea.addEventListener('mousedown', onPointerDown);
      window.addEventListener('mouseup', onPointerUp);

      // //автозагрузка данных (без кнопки, по умолчанию)
      loadAllData();
    });

    // //функция: разблокировка по PIN (после этого виден UI)
    function unlockByPin(){
      const pin = document.getElementById('pin').value.trim();
      const user = PIN_MAP[pin];
      const err = document.getElementById('pinError');
      if(!user){
        err.style.display = 'block';
        setTimeout(()=> err.style.display='none', 1600);
        return;
      }
      currentUser = user;
      document.getElementById('userPill').textContent = `Пользователь: ${currentUser}`;
      document.getElementById('lock-screen').style.display = 'none';
      const appRoot = document.getElementById('appRoot');
      appRoot.style.filter = 'none';
      appRoot.style.pointerEvents = 'auto';
      appRoot.setAttribute('aria-hidden','false');
    }

    if ('serviceWorker' in navigator) {
  window.addEventListener('load', () => {
    navigator.serviceWorker.register('/service-worker.js');
  });
}

    // Если приложение открыто в Safari, покажем подсказку «Добавить на экран Домой»
  if (!window.navigator.standalone) {
    const hint = document.createElement('div');
    hint.textContent = 'Добавьте приложение на экран «Домой» через меню Safari, чтобы открыть его во весь экран.';
    Object.assign(hint.style, {
      position: 'fixed', bottom: '20px', left: '50%', transform: 'translateX(-50%)',
      background: 'rgba(0,0,0,0.7)', color: '#fff', padding: '10px 14px',
      borderRadius: '8px', fontSize: '14px', zIndex: '10000'
    });
    document.body.appendChild(hint);
    setTimeout(() => hint.remove(), 6000);
  }
  </script>
</body>
</html>
